(function(n){function i(n,t,i,r,u){var f=document.createElement("canvas"),e;return f.width=t,f.height=i,e=f.getContext("2d"),e.drawImage(n,0,0,r,u,0,0,t,i),f.toDataURL("image/jpeg")}var t=new Vue({el:"#app",data:{typeList:pageData.types,attrList:pageData.attrs,entity:{ProductTypeId:null,Name:"",Description:"",UnitName:"份",MinBuyQuantity:1,Formats:[{ID:0,Code:"",Name:"",Price:0,Stock:-1,PackingPrice:0,PackingQuantity:1}],Attributes:[]},imgsrc:null,showError:!1},methods:{addType:function(){n.view({name:"typeView",title:"添加分类",footDisplay:"block",template:'<div class="panel-body form-horizontal">                            <div class="form-group">                                <label class= "control-label col-xs-2">                                    <span class="require">分类名称<\/span>                                <\/label>                            <div class="col-xs-9">                                <input type="text" autofocus placeholder="请填写分类名称" class="form-control" />                            <\/div>                        <\/div>'})},save:function(t){var r=n.extend({},this._data.entity),f,u,o,e;if(!r.ProductTypeId||!r.Name||!r.UnitName||!r.MinBuyQuantity){n.alert("请将表单填写完整！","warning");this._data.showError=!0;return}if(f=0,r.Formats.length>1&&(f=r.Formats.filter(function(t){return!n.trim(t.Name)}).length),f>0){n.alert("请输入规格名称");return}if(r.Attributes.length>0)for(u=0,o=r.Attributes.length;u<o;u++){if(!n.trim(r.Attributes[u].Name)){n.alert("请填写属性名称");return}delete r.Attributes[u].container}this._data.imgsrc&&(e=document.getElementById("img"),r.img400=this._data.imgsrc,r.img200=i(e,200,150,400,300),r.img100=i(e,100,75,400,300));n.loading();axios.post("/Product/Save",r).then(function(i){if(n.loaded(),!i.data.success){n.alert(i.data.msg);return}n.alert("保存成功");setTimeout(()=>{if(t){window.location.reload();return}window.location.href="/Product"},2e3)})},cancel:function(){window.location.href="/Product"},selectFile:function(){n("#file").click()},removeImg:function(){this._data.imgsrc=null},addFormat:function(){this._data.entity.Formats.push({ID:0,Code:"",Name:"",Price:0,Stock:-1,PackingPrice:0,PackingQuantity:1})},removeFormat:function(n){this._data.entity.Formats.remove(n)},addAttr:function(){this._data.entity.Attributes.push({ID:0,Name:"",Item1:"",Item2:"",Item3:"",Item4:"",Item5:"",Item6:"",Item7:"",Item8:"",container:{list:[],attrLeft:0,attrTop:0,attrDisplay:!1,attrOpacity:0,detailLeft:0,detailTop:0,detailDisplay:!1,detailOpacity:0,detailIndex:1}})},removeAttr:function(n){this._data.entity.Attributes.remove(n)},attrFocus:function(n,t){t.container.attrOpacity=1;t.container.attrLeft=n.target.offsetLeft;t.container.attrTop=n.target.offsetTop+60;t.container.attrDisplay=!0},attrBlur:function(n,t){t.container.attrOpacity=0;setTimeout(function(){t.container.attrOpacity=0;t.container.attrDisplay=!1},200)},detailFocus:function(n,t,i){t.container.detailOpacity=1;t.container.detailLeft=n.target.offsetLeft;t.container.detailTop=n.target.offsetTop+40;t.container.detailDisplay=!0;t.container.detailIndex=i},detailBlur:function(n,t){t.container.detailOpacity=0;setTimeout(function(){t.container.detailOpacity=0;t.container.detailDisplay=!1},200)},selectAttr:function(n,t){n.container.list=t.childs;n.Name=t.name},selectDetail:function(n,t,i){n["Item"+i]=t}}}),r;n(document.body).on("click","#typeView .btn-save",function(){var i=n("#typeView"),r=i.find("input"),u=n.trim(r.val()),f,e;if(!u){n.alert("请填写分类名称");r.focus().closest(".form-group").addClass("has-error");return}f=t._data.typeList[t._data.typeList.length-1].sort+1;e={name:u,sort:f,id:0};axios.post("/Product/AddType",e).then(function(n){t._data.typeList.push(n.data);i.modal("hide")})});r=new bjj.PhotoClip("#clipArea",{size:[400,300],outputSize:[400,300],file:"#file",ok:"#clipBtn",loadStart:function(){n(".cover-wrap").fadeIn()},loadComplete:function(){},clipFinish:function(i){n(".cover-wrap").fadeOut();t.imgsrc=i}})})(jQuery);