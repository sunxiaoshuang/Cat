(function(n){function r(n,t,i,r,u){var f=document.createElement("canvas"),e;return f.width=t,f.height=i,e=f.getContext("2d"),e.drawImage(n,0,0,r,u,0,0,t,i),f.toDataURL("image/jpeg")}var i=null,t,u;!pageData.entity||(pageData.entity.attributes.forEach(function(n){n.container={list:[],attrLeft:0,attrTop:0,attrDisplay:!1,attrOpacity:0,detailLeft:0,detailTop:0,detailDisplay:!1,detailOpacity:0,detailIndex:1}}),!!pageData.entity&&pageData.entity.images.length>0&&(i=appConfig.apiUrl+"/File/Product/"+pageData.entity.businessId+"/400x300/"+pageData.entity.images[0].name+"."+pageData.entity.images[0].extensionName));t=new Vue({el:"#app",data:{typeList:pageData.types,attrList:pageData.attrs,entity:pageData.entity||{id:0,productTypeId:null,name:"",description:"",unitName:"份",minBuyQuantity:1,formats:[{id:0,code:"",name:"",price:0,stock:-1,packingPrice:0,packingQuantity:1}],attributes:[]},imgsrc:i,showError:!1,isDisabled:!1},methods:{addType:function(){n.view({name:"typeView",title:"添加分类",footDisplay:"block",template:'<div class="panel-body form-horizontal">                            <div class="form-group">                                <label class= "control-label col-xs-2">                                    <span class="require">分类名称<\/span>                                <\/label>                            <div class="col-xs-9">                                <input type="text" autofocus placeholder="请填写分类名称" class="form-control" />                            <\/div>                        <\/div>'})},save:function(t){var i=n.extend({},this._data.entity),f,u,o,e,s;if(!i.productTypeId||!i.name||!i.unitName||!i.minBuyQuantity){n.alert("请将表单填写完整！","warning");this._data.showError=!0;return}if(f=0,i.formats.length>1&&(f=i.formats.filter(function(t){return!n.trim(t.name)}).length),f>0){n.alert("请输入规格名称");return}if(i.attributes.length>0)for(u=0,o=i.attributes.length;u<o;u++)if(!n.trim(i.attributes[u].name)){n.alert("请填写属性名称");return}this._data.imgsrc&&this._data.imgsrc.indexOf(appConfig.apiUrl)===-1&&(e=document.getElementById("img"),i.img400=this._data.imgsrc,i.img200=r(e,200,150,400,300),i.img100=r(e,100,75,400,300));n.loading();this.isDisabled=!0;s=i.id===0?"/Product/Save":"/Product/Update";axios.post(s,i).then(function(i){if(n.loaded(),!i.data.success){n.alert(i.data.msg);return}n.alert("保存成功","success");setTimeout(()=>{if(t){window.location.reload();return}window.location.href="/Product"},2e3)}).catch(function(t){this.isDisabled=!1;n.loaded();n.alert(t)})},cancel:function(){window.location.href="/Product"},selectFile:function(){n("#file").click()},removeImg:function(){this._data.imgsrc=null},addFormat:function(){this._data.entity.formats.push({id:0,code:"",name:"",price:0,stock:-1,packingPrice:0,packingQuantity:1})},removeFormat:function(n){this._data.entity.formats.remove(n)},addAttr:function(){this._data.entity.attributes.push({id:0,name:"",item1:"",item2:"",item3:"",item4:"",item5:"",item6:"",item7:"",item8:"",container:{list:[],attrLeft:0,attrTop:0,attrDisplay:!1,attrOpacity:0,detailLeft:0,detailTop:0,detailDisplay:!1,detailOpacity:0,detailIndex:1}})},removeAttr:function(n){this._data.entity.attributes.remove(n)},attrFocus:function(n,t){t.container.attrOpacity=1;t.container.attrLeft=n.target.offsetLeft;t.container.attrTop=n.target.offsetTop+60;t.container.attrDisplay=!0},attrBlur:function(n,t){t.container.attrOpacity=0;setTimeout(function(){t.container.attrOpacity=0;t.container.attrDisplay=!1},200)},detailFocus:function(n,t,i){t.container.detailOpacity=1;t.container.detailLeft=n.target.offsetLeft;t.container.detailTop=n.target.offsetTop+40;t.container.detailDisplay=!0;t.container.detailIndex=i},detailBlur:function(n,t){t.container.detailOpacity=0;setTimeout(function(){t.container.detailOpacity=0;t.container.detailDisplay=!1},200)},selectAttr:function(n,t){n.container.list=t.childs;n.name=t.name},selectDetail:function(n,t,i){n["item"+i]=t}}});n(document.body).on("click","#typeView .btn-save",function(){var i=n("#typeView"),r=i.find("input"),u=n.trim(r.val()),f,e;if(!u){n.alert("请填写分类名称");r.focus().closest(".form-group").addClass("has-error");return}f=t._data.typeList.length===0?1:t._data.typeList[t._data.typeList.length-1].sort+1;e={name:u,sort:f,id:0};axios.post("/Product/AddType",e).then(function(n){t._data.typeList.push(n.data);i.modal("hide")})});u=new bjj.PhotoClip("#clipArea",{size:[400,300],outputSize:[400,300],file:"#file",ok:"#clipBtn",loadStart:function(){n(".cover-wrap").fadeIn()},loadComplete:function(){},clipFinish:function(i){n(".cover-wrap").fadeOut();t.imgsrc=i}})})(jQuery);