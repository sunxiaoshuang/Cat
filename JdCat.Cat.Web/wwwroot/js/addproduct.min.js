(function(n){function e(t,i){var f=this,r=0,u;this.scopeList.forEach(function(n){n.checked&&(r+=n.value)});t.scope=r;n.loading();this.isDisabled=!0;u=t.id===0?"/Product/Save":"/Product/Update";axios.post(u,t).then(function(t){if(n.loaded(),!t.data.success){n.alert(t.data.msg);return}n.alert("保存成功","success");setTimeout(()=>{if(i){window.location.reload();return}window.location.href="/Product"},2e3)}).catch(function(t){f.isDisabled=!1;n.loaded();n.alert(t)})}function s(){var n=JSON.parse(JSON.stringify(f));n.forEach(function(n){n.checked=!1});i=new Vue({el:`#setMeal`,data:{typeList:n,productList:[]},methods:{open:function(n){var t=n.checked;this.typeList.forEach(function(n){n.checked=!1});n.checked=!t},choice:function(n){var t=this.productList.filter(t=>t.id===n.id);t.length>0||this.productList.push(n)},remove:function(n){this.productList.splice(n,1)}}});this.on("hidden.bs.modal",function(){i&&(i.$destroy(),i=null)})}function o(n,t,i,r,u){var f=document.createElement("canvas"),e;return f.width=t,f.height=i,e=f.getContext("2d"),e.drawImage(n,0,0,r,u,0,0,t,i),f.toDataURL("image/jpeg")}var r=null,u,f,t,i,h;pageData.entity&&(pageData.entity.attributes.forEach(function(n){n.container={list:[],attrLeft:0,attrTop:0,attrDisplay:!1,attrOpacity:0,detailLeft:0,detailTop:0,detailDisplay:!1,detailOpacity:0,detailIndex:1}}),!!pageData.entity&&pageData.entity.images.length>0&&(r=appConfig.apiUrl+"/File/Product/"+pageData.entity.businessId+"/400x300/"+pageData.entity.images[0].name+"."+pageData.entity.images[0].extensionName));t=new Vue({el:"#app",data:{typeList:pageData.types,attrList:pageData.attrs,productTypes:null,scopeList:[{name:"外卖",value:1,checked:!1},{name:"堂食",value:2,checked:!1}],entity:pageData.entity||{id:0,productTypeId:null,name:"",description:"",unitName:"份",minBuyQuantity:1,formats:[{id:0,code:null,name:"",price:0,stock:-1,packingPrice:0,packingQuantity:1}],attributes:[],scope:3,tag1:[],feature:0,isDiscount:!0},imgsrc:r,showError:!1,isDisabled:!1},created:function(){var n=this;this.scopeList.forEach(function(t){n.entity.scope&t.value&&(t.checked=!0)})},computed:{feature:function(){return this.entity.feature==0?"单品":this.entity.feature==1?"招牌":this.entity.feature==2?"套餐":""}},methods:{addType:function(){n.view({name:"typeView",title:"添加分类",footDisplay:"block",template:'<div class="panel-body form-horizontal">                            <div class="form-group">                                <label class= "control-label col-xs-2">                                    <span class="require">分类名称<\/span>                                <\/label>                            <div class="col-xs-9">                                <input type="text" autofocus placeholder="请填写分类名称" class="form-control" />                            <\/div>                        <\/div>'})},save:function(t){var i=n.extend({},this._data.entity),s=this,u,r,h,f;if(console.log(i),!i.productTypeId||!i.name||!i.unitName||!i.minBuyQuantity){n.alert("请将表单填写完整！","warning");this._data.showError=!0;return}if(i.feature==2&&!i.productIdSet){n.alert("请选择套餐商品！","error");return}if(u=0,i.formats.length>1&&(u=i.formats.filter(function(t){return!n.trim(t.name)}).length),u>0){n.alert("请输入规格名称");return}if(i.attributes.length>0)for(r=0,h=i.attributes.length;r<h;r++)if(!n.trim(i.attributes[r].name)){n.alert("请填写属性名称");return}this._data.imgsrc&&this._data.imgsrc.indexOf(appConfig.apiUrl)===-1&&(f=document.getElementById("img"),i.img400=this._data.imgsrc,i.img200=o(f,200,150,400,300),i.img100=o(f,100,75,400,300));i.id===0?e.call(s,i,t):axios.get("/Product/IsCanUpdate/"+i.id).then(function(r){if(!r.data.success){n.alert("折扣中的商品不允许修改！");return}e.call(s,i,t)})},cancel:function(){window.location.href="/Product"},selectFile:function(){n("#file").click()},removeImg:function(){this._data.imgsrc=null},addFormat:function(){this._data.entity.formats.push({id:0,code:null,name:"",price:0,stock:-1,packingPrice:0,packingQuantity:1})},removeFormat:function(n){this._data.entity.formats.remove(n)},addAttr:function(){this._data.entity.attributes.push({id:0,name:"",item1:"",item2:"",item3:"",item4:"",item5:"",item6:"",item7:"",item8:"",container:{list:[],attrLeft:0,attrTop:0,attrDisplay:!1,attrOpacity:0,detailLeft:0,detailTop:0,detailDisplay:!1,detailOpacity:0,detailIndex:1}})},removeAttr:function(n){this._data.entity.attributes.remove(n)},attrFocus:function(n,t){t.container.attrOpacity=1;t.container.attrLeft=n.target.offsetLeft;t.container.attrTop=n.target.offsetTop+60;t.container.attrDisplay=!0},attrBlur:function(n,t){t.container.attrOpacity=0;setTimeout(function(){t.container.attrOpacity=0;t.container.attrDisplay=!1},200)},detailFocus:function(n,t,i){t.container.detailOpacity=1;t.container.detailLeft=n.target.offsetLeft-40;t.container.detailTop=n.target.offsetTop+40;t.container.detailDisplay=!0;t.container.detailIndex=i},detailBlur:function(n,t){t.container.detailOpacity=0;setTimeout(function(){t.container.detailOpacity=0;t.container.detailDisplay=!1},200)},selectAttr:function(n,t){n.container.list=t.childs;n.name=t.name},selectDetail:function(n,t,i){n["item"+i]=t},selectProduct:function(){var r=this;axios.get("/Product/SelectTypes").then(function(e){f=e.data;axios.get("/Product/SelectProduct").then(function(f){u=f.data;r.selectProduct=function(){n.view({name:"selectproduct",title:"选择套餐商品",footDisplay:"block",template:u,load:function(){s.call(this)},submit:function(){if(i.productList.length===0)return t.entity.productIdSet=null,!0;var n="";return t.entity.tag1=t.entity.tag1.slice(0,0),i.productList.forEach(function(i){n+=i.id+",";t.entity.tag1.push({key:i.id,value:i.name})}),n=n.slice(0,n.length-1),t.entity.productIdSet=n,!0}})};r.selectProduct()})}).catch(function(t){n.alert(t)})}}});n(document.body).on("click","#typeView .btn-save",function(){var i=n("#typeView"),r=i.find("input"),u=n.trim(r.val()),f,e;if(!u){n.alert("请填写分类名称");r.focus().closest(".form-group").addClass("has-error");return}f=t._data.typeList.length===0?1:t._data.typeList[t._data.typeList.length-1].sort+1;e={name:u,sort:f,id:0};axios.post("/Product/AddType",e).then(function(n){t._data.typeList.push(n.data);i.modal("hide")})});h=new bjj.PhotoClip("#clipArea",{size:[400,300],outputSize:[400,300],file:"#file",ok:"#clipBtn",loadStart:function(){n(".cover-wrap").fadeIn()},loadComplete:function(){},clipFinish:function(i){n(".cover-wrap").fadeOut();t.imgsrc=i}});n("#btn-closeArea").click(function(){n(".cover-wrap").fadeOut()})})(jQuery);