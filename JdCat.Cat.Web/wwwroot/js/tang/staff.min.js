(function(){function r(n){this.on("hidden.bs.modal",function(){n&&(n.$destroy(),n=null)})}var n=new Vue({el:"#app",data:{items:[]},methods:{add:function(){t()},modify:function(n){t(n)},remove:function(t){$.primary(`确定删除员工[${t.name}]吗？`,function(){return axios.delete(`/tang/deleteStaff/${t.id}`).then(function(i){if(!i.data.success){$.alert(i.data.msg);return}n.items.remove(t);$.alert(i.data.msg,"success")}).catch(function(n){$.alert(n)}),!0})},resetPwd:function(){var n,t=`
                    <div class="row form-horizontal" id="resetPwd">
                        <div class="form-group">
                            <label class="control-label col-xs-3">
                                <span class="require">新密码：</span>
                            </label>
                            <div class="col-xs-8">
                                <input class="form-control" type="password" v-model.trim="password" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-xs-3">
                                <span class="require">再次输入：</span>
                            </label>
                            <div class="col-xs-8">
                                <input class="form-control" type="password" v-model.trim="password1" />
                            </div>
                        </div>
                    </div>
                `;return function(i){$.view({title:"重置密码",footDisplay:"block",template:t,load:function(){n=new Vue({el:"#resetPwd",data:{password:"",password1:""}});r.call(this,n)},submit:function(){if(!n.password){$.alert("请输入新密码");return}if(n.password!==n.password1){$.alert("两次输入的密码不一致");return}return axios.put(`/tang/resetPassword/${i.id}?pwd=${n.password}`).then(function(n){if(!n.data.success){$.alert(n.data.msg);return}$.alert(n.data.msg,"success")}).catch(function(n){$.alert(n)}),!0}})}}(),bindProduct:function(n){(n.staffPost.authority&4)!=0&&i(n)},genderFormat:function(n){return n===1?"男":n===2?"女":"未知"},timeFormat:function(n){return n?n.substring(0,10):""}},created:function(){var n=this;axios.get("/tang/getStaffs").then(function(t){n.items=t.data.list})}}),t=function(i){var e,f,u;$.loading();axios.all([axios.get("/tang/editStaff"),axios.get("/tang/getStaffPosts")]).then(function(n){e=n[0].data;f=n[1].data.staffPosts||[];f=f.map(function(n){return{id:n.id,name:n.name}})}).then(function(){$.loaded();t=function(t){var o=!t,i=t||{};$.view({title:o?"新增员工":"编辑员工",footDisplay:"block",template:e,load:function(){var n=this;u=new Vue({el:"#edit-staff",data:{isAdd:o,name:i.name,alise:i.alise,password:"",password1:"",gender:i.gender||0,enterTime:i.enterTime?i.enterTime.substring(0,10):"",birthday:i.birthday?i.birthday.substring(0,10):"",cardId:i.cardId,staffPostId:i.staffPostId||0,posts:JSON.parse(JSON.stringify(f)),genderList:[{name:"男",value:1},{name:"女",value:2}]},created:function(){}});n.find(".birthday").datetimepicker($.dateOptions).on("changeDate",function(){u.birthday=this.value});n.find(".enterTime").datetimepicker($.dateOptions).on("changeDate",function(){u.enterTime=this.value});r.call(this,u)},submit:function(){if(!u.staffPostId){$.alert("请选择所属岗位");return}if(!u.name){$.alert("请输入员工姓名");return}if(!u.alise){$.alert("请输入登录帐号");return}if(o){if(!u.password){$.alert("请输入登录密码");return}if(u.password!==u.password1){$.alert("两次输入密码不一致");return}}if(!u.gender){$.alert("请选择员工性别");return}var r=o?"/tang/addStaff":"/tang/updateStaff",f={id:i.id||0,name:u.name,alise:u.alise,password:u.password,gender:u.gender,birthday:u.birthday,enterTime:u.enterTime,cardId:u.cardId,staffPostId:u.staffPostId};return axios.post(r,f).then(function(i){if(!i.data.success){$.alert(i.data.msg);return}$.alert(i.data.msg,"success");o?n.items.push(i.data.data):n.items.replace(t,i.data.data)}).catch(function(n){$.alert(n)}),!0}})};t(i)})},i=function(t){var u,f;$.loading();axios.all([axios.get(`/product/getProductTree?isSetMeal=1`),axios.get(`/tang/checkProducts`)]).then(function(e){u=e[1].data;f=e[0].data.map(function(n){return n.checked=!1,n});$.loaded();var o=function(t){var e=this,o,s=JSON.parse(JSON.stringify(f)),h=[],i=[];s.forEach(function(n){i=i.concat(n.list)});i.forEach(function(t){(t.checked=!1,t.selected=!1,t.title="",n.items.forEach(n=>{n.productIds.indexOf(t.id)>-1&&(t.title+=n.name+",")}),t.title)&&(t.title=`已绑定${t.title.slice(0,t.title.length-1)}`)});t&&t.length>0&&t.forEach(function(n){var t=i.first(function(t){return t.id===n});t&&(t.checked=!0,h.push(t))});$.view({title:`厨师[${e.name}]绑定菜单`,footDisplay:"block",template:u,dialogWidth:800,load:function(){o=new Vue({el:"#bindProduct",data:{typeList:s,products:i,productList:h,search:{key:"",result:[],boxHeight:0}},watch:{"search.key":function(n){this.seek(n)}},methods:{focus:function(){this.seek(this.search.key)},blur:function(){var n=this;setTimeout(function(){n.search.boxHeight=0},200)},seek:function(n){if(!n){this.search.result=[];this.search.boxHeight="0";return}this.search.boxHeight="120px";this.products.forEach(n=>n.selected=!1);this.search.result=this.products.filter(t=>t.name.indexOf(n)>-1||t.code.indexOf(n)>-1||t.pinyin.indexOf(n)>-1||t.firstLetter.indexOf(n)>-1).slice(0,8)},down:function(){var n=this;this.move(function(t){return t===n.search.result.length-1?t=0:t++,t})},up:function(){var n=this;this.move(function(t){return t===0?t=n.search.result.length-1:t===-1?t=0:t--,t})},enter:function(){var n=this.search.result.filter(n=>n.selected);n.length!==0&&this.choice(n[0])},clear:function(){this.search.key=""},move:function(n){if(this.search.result.length!==0){var r,t,i=this.search.result.filter(n=>n.selected);i.length>0&&(r=i[0]);t=this.search.result.indexOf(r);t=n(t);i.forEach(n=>n.selected=!1);this.search.result[t].selected=!0}},open:function(n){n.checked=!n.checked},choice:function(n){if(!n.checked){if(n.title){$.alert(n.title,"warning");return}n.checked=!0;this.productList.push(n)}},remove:function(n){n.checked=!1;this.productList.remove(n)}}});r.call(this,o)},submit:function(){var n=o.productList.map(function(n){return{staffId:e.id,productId:n.id}});return axios.post(`/tang/bindProductsForCook/${e.id}`,n).then(function(n){if(!n.data.success){$.alert(n.data.msg);return}e.productIds=o.productList.map(n=>n.id);$.alert(n.data.msg,"success")}).catch(function(n){$.alert(n)}),!0}})};i=function(t){t.productIds?o.call(t,t.productIds):axios.get(`/tang/getProductIdsWithCook`).then(function(i){var r=i.data;n.items.forEach(n=>{var t=r.first(t=>t.id===n.id);t&&(n.productIds=t.ids)});o.call(t,t.productIds)}).catch(function(n){$.alert(n)})};i(t)}).catch(function(n){$.alert(n)})};$(document).on("mouseenter","a[title!=''], div[title!='']",function(){this.title&&$(this).tooltip()})})();