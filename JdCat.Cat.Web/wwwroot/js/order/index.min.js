(function(n){function o(n){return n.map(function(n){n.expend=!1}),n}var r=["外卖","堂食"],u=["","线上支付"],f=["第三方平台","自己配送","自提"],e={"1":"已付款","2":"已拒单","4":"待配送","8":"待配送","16":"配送中","32":"配送异常","64":"已送达","128":"用户已确认收货","256":"未付款","512":"已评价","1024":"已关闭","2048":"配送已取消"},t=null,i=new Vue({el:"#app",data:{buttons:[{name:"全部订单",type:0,selected:!0},{name:"待付款",type:256,selected:!1},{name:"待接单",type:1,selected:!1},{name:"已接单",type:2052,selected:!1},{name:"待确认",type:64,selected:!1},{name:"已关闭",type:1024,selected:!1},{name:"已完成",type:128,selected:!1},],orderList:[],deviceList:pageObj.deviceList,pageObj:{pageIndex:1,pageSize:20,pageCount:0,recordCount:0},curType:null,sendTypes:[{name:"达达配送",selected:!1,type:0},{name:"自己配送",selected:!1,type:1}],curOrder:null,printerCode:localStorage.getItem("defaultPrinter"),curSendType:null,search_code:pageObj.code,search_phone:""},methods:{initPageObj:function(){this.pageObj.pageIndex=1;this.pageObj.pageSize=20;this.pageObj.pageCount=0;this.pageObj.recordCount=0},loadData:function(){var t=this;axios.post(`/order/getorder?status=${this.curType.type}&code=${this.search_code}&phone=${this.search_phone}`,this.pageObj).then(function(n){t.orderList=o(n.data.data.list);t.pageObj.recordCount=n.data.data.rows;t.pageObj.pageCount=Math.ceil(t.pageObj.recordCount/t.pageObj.pageSize)}).catch(function(t){n.loaded();n.alert(t)})},changeType:function(n){this.buttons.forEach(n=>{n.selected=!1});n.selected=!0;this.curType=n;this.initPageObj();this.loadData()},expend:function(n){n.expend=!n.expend},prevPage:function(){this.pageObj.pageIndex!==1&&(this.pageObj.pageIndex--,this.loadData())},changePage:function(n){this.pageObj.pageIndex!==n&&(this.pageObj.pageIndex=n,this.loadData())},nextPage:function(){this.pageObj.pageIndex!==this.pageObj.pageCount&&(this.pageObj.pageIndex=this.pageObj.pageIndex+1,this.loadData())},receive:function(t){n("#modal-sendType").modal({backdrop:"static"});this.curOrder=t},reject:function(t){n.view({title:"原因",footDisplay:!0,template:`
                        <div class='row'>
                            <div class='col-xs-12'>请输入拒绝原因</div>
                            <div class='col-xs-12'>
                                <textarea class='form-control'></textarea>
                            </div>
                            <div class='col-xs-12'>
                                <h5 class='text-danger'>提示：订单取消后，订单金额将会在一天后退回</h5>
                            </div>
                        </div>`,submit:function(i,r){var u=r.find("textarea").val();return u?(axios.get("/order/reject/"+t.id+"?msg="+u).then(function(t){t.data.success?n.alert(t.data.msg,"success"):n.alert(t.data.msg)}).catch(function(t){n.alert(t)}),!0):(n.alert("请输入拒绝原因"),!1)}})},cancel:function(i){n.view({title:"取消原因",saveText:"确定",footDisplay:!0,template:`
                        <div class='row' id='vueReason'>
                            <label class='label-control col-xs-12 nowarp'>选择原因：</label>
                            <div class='col-xs-12'>
                                <select class='form-control' v-model='flagId'>
                                    <option v-for='reason in reasonList' :value='reason.flagId'>{{reason.reason}}</option>
                                </select>
                            </div>
                            <hr class='clearfix' />
                            <label class='label-control col-xs-2 nowarp'>备注：</label>
                            <div class='col-xs-12'>
                                <textarea class='form-control' placeholder='输入其他原因' v-model='reason'></textarea>
                            </div>
                            <div class='col-xs-12' v-if='tipShow'>
                                <h5 class='text-danger'>提示：配送取消后，将会产生一定的违约金</h5>
                            </div>
                        </div>`,load:function(){t=new Vue({el:"#vueReason",data:{reasonList:pageObj.reasonList,flagId:1,reason:null,tipShow:i.deliveryMode==0}});this.on("hidden.bs.modal",function(){t&&(t.$destroy(),t=null)})},submit:function(){return axios.get(`/order/cancel/${i.id}?flagId=${t.flagId}&reason=${t.reason}`).then(function(t){t.data.success?(n.alert(t.data.msg,"success"),i.status=t.data.data):n.alert(t.data.msg)}).catch(function(t){n.alert(t)}),!0}})},achieve:function(t){n.primary("确保订单已经送达？",function(){return axios.get("/order/achieve/"+t.id).then(function(i){i.data.success?(n.alert(i.data.msg,"success"),t.status=i.data.data):n.alert(i.data.msg)}).catch(function(t){n.alert(t)}),!0})},selectSendType:function(n){this.sendTypes.forEach(n=>n.selected=!1);n.selected=!0;this.curSendType=n},submitSend:function(){var t=this;if(!this.curSendType){n.alert("请选择配送方式");return}if(!this.curOrder){n.alert("操作错误，请重新选择要配送的订单");return}n.loading();n("#modal-sendType").modal("hide");axios.get(`/order/send/${this.curOrder.id}?type=${this.curSendType.type}`).then(function(i){n.loaded();i.data.success?(n.alert("操作成功","success"),t.curOrder.status=i.data.data.status,t.curOrder.deliveryMode=i.data.data.mode):n.alert(i.data.msg)}).catch(function(t){n.loaded();n.alert(t)})},changePrinter:function(){localStorage.setItem("defaultPrinter",this.printerCode)},print:function(t){axios.get(`/order/print/${t.id}?device_no=${this.printerCode}`).then(function(t){t.data.success?n.alert(t.data.msg,"success"):n.alert(t.data.msg)}).catch(function(t){n.alert(t)})},search:function(){this.initPageObj();this.loadData()}},filters:{category:function(n){return r[n]},paymentType:function(n){return u[n]},status:function(n){return e[n]},deliveryType:function(n){return f[n]}},created:function(){var n=this;this.curType=this.buttons[0];this.loadData()}});n("#modal-sendType").on("hidden.bs.modal",()=>{i.sendTypes.forEach(n=>n.selected=!1),i.curSendType=null})})(jQuery);