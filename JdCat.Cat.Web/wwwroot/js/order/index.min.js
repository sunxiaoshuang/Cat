(function(n){function c(n){return n.length===1?n[0].expend=!0:n.map(function(n){n.expend=!1}),n}var f=["外卖","堂食"],e=["","线上支付"],o={"1":"已付款","2":"已拒单","4":"待配送","8":"待配送","16":"配送中","32":"配送异常","64":"已送达","128":"用户已确认收货","256":"未付款","512":"已评价","1024":"已关闭","2048":"配送已取消","4096":"订单已取消"},s={"0":"未知","1":"自己配送","2":"达达配送","3":"美团配送","4":"蜂鸟配送","5":"点我达配送","6":"一城飞客配送","7":"顺丰同城"},h=728,t=null,r,i,u=new Vue({el:"#app",data:{buttons:[{name:"全部订单",type:0,selected:!0},{name:"待付款",type:256,selected:!1},{name:"待接单",type:1,selected:!1},{name:"已接单",type:2052,selected:!1},{name:"待确认",type:64,selected:!1},{name:"已关闭",type:1024,selected:!1},{name:"已完成",type:128,selected:!1}],orderList:[],deviceList:pageObj.deviceList,pageObj:{pageIndex:1,pageSize:20,pageCount:0,recordCount:0},curType:null,sendTypes:[{name:"达达配送",selected:!1,type:0,logisticsType:2,doing:!1},{name:"美团配送",selected:!1,type:0,logisticsType:3,doing:!0},{name:"点我达配送",selected:!1,type:0,logisticsType:5,doing:!1},{name:"一城飞客配送",selected:!1,type:0,logisticsType:6,doing:!1},{name:"自己配送",selected:!1,type:1,logisticsType:1,doing:!1},{name:"顺丰同城",selected:!1,type:1,logisticsType:7,doing:!1}],curOrder:null,printerCode:localStorage.getItem("defaultPrinter"),curSendType:null,search_code:pageObj.code,search_phone:""},methods:{initPageObj:function(){this.pageObj.pageIndex=1;this.pageObj.pageSize=20;this.pageObj.pageCount=0;this.pageObj.recordCount=0},loadData:function(){var t=this;axios.post(`/order/getorders?status=${this.curType.type}&code=${this.search_code}&phone=${this.search_phone}`,this.pageObj).then(function(n){t.orderList=c(n.data.data.list);t.pageObj.recordCount=n.data.data.rows;t.pageObj.pageCount=Math.ceil(t.pageObj.recordCount/t.pageObj.pageSize)}).catch(function(t){n.loaded();n.alert(t)})},changeType:function(n){this.buttons.forEach(n=>{n.selected=!1});n.selected=!0;this.curType=n;this.initPageObj();this.loadData()},expend:function(t){(t.expend=!t.expend,t.loaded)||axios.get("/Order/GetOrderDetail/"+t.id).then(function(n){t.loaded=!0;for(var i in t)t[i]||(t[i]=n.data[i])}).catch(function(t){n.alert(t)})},prevPage:function(){this.pageObj.pageIndex!==1&&(this.pageObj.pageIndex--,this.loadData())},changePage:function(n){this.pageObj.pageIndex!==n&&(this.pageObj.pageIndex=n,this.loadData())},nextPage:function(){this.pageObj.pageIndex!==this.pageObj.pageCount&&(this.pageObj.pageIndex=this.pageObj.pageIndex+1,this.loadData())},receive:function(t){n("#modal-sendType").modal({backdrop:"static"});this.curOrder=t},reject:function(t){n.view({title:"原因",footDisplay:!0,template:`
                        <div class='row'>
                            <div class='col-xs-12'>请输入拒绝原因</div>
                            <div class='col-xs-12'>
                                <textarea class='form-control'></textarea>
                            </div>
                            <div class='col-xs-12'>
                                <h5 class='text-danger color-red'>提示：拒绝或取消订单后，订单金额将原路返回消费者</h5>
                            </div>
                        </div>`,submit:function(i,r){var u=r.find("textarea").val();return u?(n.loading(),axios.get("/order/reject/"+t.id+"?msg="+u).then(function(i){n.loaded();i.data.success?(n.alert(i.data.msg,"success"),t.status=i.data.data.status,t.refundStatus=i.data.data.refundStatus):n.alert(i.data.msg)}).catch(function(t){n.loaded();n.alert(t)}),!0):(n.alert("请输入拒绝原因"),!1)}})},cancel:function(i){n.view({title:"取消原因",saveText:"确定",footDisplay:!0,template:`
                        <div class='row' id='vueReason'>
                            <label class='label-control col-xs-12 nowarp'>选择原因：</label>
                            <div class='col-xs-12'>
                                <select class='form-control' v-model='flagId'>
                                    <option v-for='reason in reasonList' :value='reason.flagId'>{{reason.reason}}</option>
                                </select>
                            </div>
                            <hr class='clearfix' />
                            <label class='label-control col-xs-2 nowarp'>备注：</label>
                            <div class='col-xs-12'>
                                <textarea class='form-control' placeholder='输入其他原因' v-model='reason'></textarea>
                            </div>
                            <div class='col-xs-12' v-if='tipShow'>
                                <h5 class='text-danger'>提示：配送取消后，将会产生一定的违约金</h5>
                            </div>
                        </div>`,load:function(){t=new Vue({el:"#vueReason",data:{reasonList:pageObj.reasonList,flagId:1,reason:null,tipShow:i.deliveryMode==0}});this.on("hidden.bs.modal",function(){t&&(t.$destroy(),t=null)})},submit:function(){return axios.get(`/order/cancel/${i.id}?flagId=${t.flagId}&reason=${t.reason}`).then(function(t){t.data.success?(n.alert(t.data.msg,"success"),i.status=t.data.data):n.alert(t.data.msg)}).catch(function(t){n.alert(t)}),!0}})},achieve:function(t){n.primary("确保订单已经送达？",function(){return axios.get("/order/achieve/"+t.id).then(function(i){i.data.success?(n.alert(i.data.msg,"success"),t.status=i.data.data):n.alert(i.data.msg)}).catch(function(t){n.alert(t)}),!0})},selectSendType:function(t){if(t.doing){n.alert("工程师正在努力对接中...","warning");return}this.sendTypes.forEach(n=>n.selected=!1);t.selected=!0;this.curSendType=t},submitSend:function(){var t=this;if(!this.curSendType){n.alert("请选择配送方式");return}if(!this.curOrder){n.alert("操作错误，请重新选择要配送的订单");return}n.loading();n("#modal-sendType").modal("hide");axios.get(`/order/send/${this.curOrder.id}?type=${this.curSendType.type}&logisticsType=${this.curSendType.logisticsType}`).then(function(i){n.loaded();i.data.success?(n.alert("操作成功","success"),t.curOrder.status=i.data.data.status,t.curOrder.deliveryMode=i.data.data.mode,t.curOrder.distributionFlow=i.data.data.flow):n.alert(i.data.msg)}).catch(function(t){n.loaded();n.alert(t)})},changePrinter:function(){localStorage.setItem("defaultPrinter",this.printerCode)},print:function(t){var r=this,i=this.deviceList.filter(function(n){return n.code==r.printerCode})[0];if(!i){n.alert("请选择小票打印设备！");return}axios.get(`/order/print/${t.id}?device_id=${i.id}`).then(function(t){t.data.success?n.alert(t.data.msg,"success"):n.alert(t.data.msg)}).catch(function(t){n.alert(t)})},addTip:function(t){r=n.view({template:`
                        <div class="row form-horizontal">
                            <div class="form-group">
                                <label class="control-label col-xs-3">
                                    <span class="require">小费总金额：</span>
                                </label>
                                <div class="col-xs-8">
                                    <input class="form-control add-tip" type="number" value="1" />
                                </div>
                            </div>
                        </div>
                    `,title:"添加小费",footDisplay:!0,submit:function(){var i=+r.find(".add-tip").val();return i>50?(n.alert("小费金额不能大于50"),!1):(axios.get(`/Order/AddTip/${t.id}?tip=${i}&code=${t.orderCode}&distributionFlow=${t.distributionFlow}`).then(function(t){if(t.data.success){n.alert("添加小费成功","success");return}n.alert(t.data.message)}).catch(function(t){n.alert(t)}),!0)}})},cancelOrder:function(t){n.view({title:"填写取消原因",saveText:"确定",footDisplay:!0,template:`<div class='form-horizontal'id='cancelReason'>
                                <div class='row'>
                                    <label class='label-control col-xs-2 nowarp'>取消原因：</label>
                                    <div class='col-xs-10'>
                                        <select class='form-control' v-model='selectedValue'>
                                            <option v-for='item in reasons' :value='item.reason'>{{item.reason}}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class='row margin-top-10'>
                                    <label class='label-control col-xs-2 nowarp'>其他原因：</label>
                                    <div class='col-xs-10'>
                                        <textarea class='form-control' v-model='reason'></textarea>
                                    </div>
                                </div>
                                <div class='row margin-top-10'>
                                    <div class='col-xs-12'>
                                        <h5 class='text-danger color-red'>提示：拒绝或取消订单后，订单金额将原路返回消费者</h5>
                                    </div>
                                </div>
                            </div>`,load:function(){var n=JSON.parse(JSON.stringify(pageObj.reasonList));i=new Vue({el:"#cancelReason",data:{reason:t.refundReason,reasons:n,selectedValue:""}});this.on("hidden.bs.modal",function(){i&&(i.$destroy(),i=null)})},submit:function(){var r=i.reason||i.selectedValue;return r?(n.loading(),axios.get(`/order/cancelOrder/${t.id}?reason=${r}`).then(function(i){n.loaded();i.data.success?(n.alert(i.data.msg,"success"),t.status=i.data.data.status,t.refundStatus=i.data.data.refundStatus):n.alert(i.data.msg)}).catch(function(t){n.loaded();n.alert(t)}),!0):(n.alert("请选择或输入取消原因"),!1)}})},search:function(){this.initPageObj();this.loadData()},checklogistics:function(t){axios.get(`/Dianwoda/OrderDetail?orderCode=${t.orderCode}_${t.distributionFlow}`).then(function(t){n.view({template:t.data,title:"配送信息"})}).catch(function(t){n.alert(t)})},category:function(n){return f[n]},paymentType:function(n){return e[n]},status:function(n){return o[n]},deliveryType:function(n){return+n.status&h===0?"":s[n.logisticsType]},gender:function(n){return n.receiverName.length>1?"":n.gender==1?"先生":n.gender==2?"女士":""}},created:function(){var n=this;this.curType=this.buttons[0];this.loadData()}});n("#modal-sendType").on("hidden.bs.modal",()=>{u.sendTypes.forEach(n=>n.selected=!1),u.curSendType=null})})(jQuery);