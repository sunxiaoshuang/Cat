(function(){function s(){var r=this,n=JSON.parse(pageData.typeList);n.forEach(function(n){n.checked=!1;n.products=n.products.filter(n=>n.formats.length===1);n.products=n.products.filter(n=>i.discountList.filter(t=>t.productId===n.id).length===0)});t=new Vue({el:`#discount`,data:{typeList:n,productList:[]},methods:{open:function(n){var t=n.checked;this.typeList.forEach(function(n){n.checked=!1});n.checked=!t},choice:function(n){var t=this.productList.filter(t=>t.id===n.id);t.length>0||this.productList.push(n)},remove:function(n){this.productList.splice(n,1)}}});this.on("hidden.bs.modal",function(){t&&(t.$destroy(),t=null)})}function e(t){$.view({template:r,title:"设置折扣商品-"+t.name,name:"view_setting",footDisplay:"block",load:function(){var i=JSON.parse(JSON.stringify(t));i.startDate&&(i.startDate=i.startDate.substring(0,10));i.endDate&&(i.endDate=i.endDate.substring(0,10));n=new Vue({el:"#setting",data:{entity:i,cycleList:[{name:"周一",value:1,checked:!0},{name:"周二",value:2,checked:!0},{name:"周三",value:4,checked:!0},{name:"周四",value:8,checked:!0},{name:"周五",value:16,checked:!0},{name:"周六",value:32,checked:!0},{name:"周日",value:64,checked:!0}]},methods:{changeTime:function(n,t){this.entity[n]=t},addTime:function(){if(!this.entity.startTime2){this.entity.startTime2="00:00";this.entity.endTime2="00:00";return}this.entity.startTime3||(this.entity.startTime3="00:00",this.entity.endTime3="00:00")},removeTime:function(){if(!!this.entity.startTime3){this.entity.startTime3=null;this.entity.endTime3=null;return}!this.entity.startTime2||(this.entity.startTime2=null,this.entity.endTime2=null)},discountChange:function(){this.entity.price=parseFloat((this.entity.oldPrice*this.entity.discount/10).toFixed(2))},priceChange:function(){this.entity.discount=parseFloat((this.entity.price/this.entity.oldPrice*10).toFixed(2))}},created:function(){this.cycleList.forEach(n=>{this.entity.cycle&n.value||(n.checked=!1)})},watch:{cycleList:{handler:function(n){var t=0;n.forEach(n=>{n.checked&&(t=t|n.value)});this.entity.cycle=t},deep:!0}}});$("#txtStartDate").datetimepicker(u).on("changeDate",function(){n.entity.startDate=this.value});$("#txtEndDate").datetimepicker(u).on("changeDate",function(){n.entity.endDate=this.value});this.on("hidden.bs.modal",function(){n&&(n.$destroy(),n=null)})},submit:function(){if(!n.entity.startDate||!n.entity.endDate)return $.alert("请选择活动日期"),!1;if(n.entity.startDate>n.entity.endDate)return $.alert("活动开始时间不能大于活动结束时间"),!1;if(n.entity.startTime1>n.entity.endTime1)return $.alert("生效时段[1]：开始时间不能大于结束时间"),!1;if(!!n.entity.startTime2){if(n.entity.startTime2>n.entity.endTime2)return $.alert("生效时段[2]：开始时间不能大于结束时间"),!1;if(n.entity.startTime2<n.entity.endTime1)return $.alert("生效时段[2]必须大于生效时段[1]"),!1}if(!!n.entity.startTime3){if(n.entity.startTime3>n.entity.endTime3)return $.alert("生效时段[3]：开始时间不能大于结束时间"),!1;if(n.entity.startTime3<n.entity.endTime2)return $.alert("生效时段[3]必须大于生效时段[2]"),!1}return axios.post("/Sale/UpdateDiscount",n.entity).then(function(n){if(!n.data.success){$.alert(n.data.msg);return}$.alert(n.data.msg,"success");var t=n.data.data,r;i.discountList.some((n,i)=>n.id!=t.id?!1:(r=i,!0));i.discountList.splice(r,1,t)}).catch(function(n){$.alert(n)}),!0}})}var o="product",t,i,n,f={"1":"周一","2":"周二","4":"周三","8":"周四","16":"周五","32":"周六","64":"周日"},r,u;Vue.component("cat-time",{props:["time"],data:function(){for(var r="00",u="00",f=[],i=[],n=0,t;n<24;)t=n.toString(),n<10&&(t="0"+t),f.push(t),n++;for(n=0;n<60;)t=n.toString(),n<10&&(t="0"+t),i.push(t),n+=5;return i.push("59"),!this.time||(r=this.time.split(":")[0],u=this.time.split(":")[1]),{hour:r,minus:u,hourList:f,minusList:i}},template:`
            <div class='cat-time'>
                <select class='form-control' v-model='hour'>
                    <option v-for='item in hourList' :value='item'>{{item}}</option>
                </select>
                <span class='split'>:</span>
                <select class='form-control' v-model='minus'>
                    <option v-for='item in minusList' :value='item'>{{item}}</option>
                </select>
            </div>`,methods:{},watch:{hour:function(){var n=this.hour+":"+this.minus;this.$emit("change",n)}}});i=new Vue({el:"#app",data:{isShow:!0,discountList:JSON.parse(pageData.discountList)},methods:{select:function(){$.view({url:"/Sale/DiscountProduct",name:o,title:"选择商品",footDisplay:"block",submit:function(){if(t.productList.length===0)return!0;var n=t.productList.map(n=>{name:n.name,oldPrice:n.formats[0].price,productId:n.id});return axios.post("/Sale/CreateDiscount",n).then(function(n){n.data.forEach(n=>i.discountList.push(n));$.alert("创建成功","success")}).catch(function(){$.alert("系统错误，请刷新后重试")}),!0},load:function(){s.call(this)}})},edit:function(n){r?e(n):($.loading(),axios.get("/Sale/DiscountDetail").then(function(t){r=t.data;e(n);$.loaded()}))},remove:function(n,t){var i=this;$.primary(`确定删除商品<b>[${n.name}]</b>的折扣活动吗？`,function(){return axios.delete("/Sale/DeleteDiscount/"+n.id).then(function(n){n.data.success?($.alert(n.data.msg,"success"),i.discountList.splice(t,1)):$.alert(n.data.msg)}),!0})}},filters:{price:function(n){return n==0?"-":"￥"+n},discount:function(n){return n?n+"折":"-"},upperLimit:function(n){return n===-1?"不限":n},activityTime:function(n){return!n.startDate||!n.endDate?"-":n.startDate.substring(0,10)+" 至 "+n.endDate.substring(0,10)},cycle:function(n){var t="",i;if(n==127)return"全部";for(i in f)n&i&&(t+=f[i]+"|");return t.length>0&&(t=t.substring(0,t.length-1)),t},validTime:function(n){var t="";return n.startTime1=="00:00"&&n.endTime1=="23:59"?"全天":(!n.startTime1||(t+=n.startTime1+"-"+n.endTime1),!n.startTime2||(t+=" | "+n.startTime2+"-"+n.endTime2),!n.startTime3||(t+=" | "+n.startTime3+"-"+n.endTime3),t)},status:function(n){return n==0?"":"生效"}}});$.loaded();u={format:"yyyy-mm-dd",autoclose:!0,maxView:1,minView:2,todayBtn:!0,todayHighlight:!0,language:"zh-CN"}})();