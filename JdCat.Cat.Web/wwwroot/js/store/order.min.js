(function(){function e(n){this.on("hidden.bs.modal",function(){n&&(n.$destroy(),n=null)})}var n=jdCat.utilMethods.now(),t=new Vue({el:"#app",data:{startDate:n,endDate:n,code:undefined,paging:{pageIndex:1,pageSize:20,pageCount:1},items:null},methods:{loadData:function(){var n=this;axios.get(`/Store/GetOrders?pageIndex=${this.paging.pageIndex}&pageSize=${this.paging.pageSize}&startDate=${this.startDate}&endDate=${this.endDate}&code=${this.code||""}`).then(function(t){n.paging.pageCount=Math.ceil(t.data.count/n.paging.pageSize);n.items=t.data.rows}).catch(function(n){$.alert(n)})},next:function(){if(this.paging.pageIndex>=this.paging.pageCount){this.paging.pageIndex=this.paging.pageCount;return}this.paging.pageIndex++;this.loadData()},pre:function(){if(this.paging.pageIndex<=1){this.paging.pageIndex=1;return}this.paging.pageIndex--;this.loadData()},page:function(n){this.paging.pageIndex!==n&&(this.paging.pageIndex=n,this.loadData())},search:function(){this.loadData()},orderStatus:function(){return statusName={1:"正在点单",2:"正在用餐",4:"已结算",8:"反结算",16:"已取消",32:"已退款"},function(n){return statusName[n]}}(),catInfo:function(n){$.loading();axios.get(`/Store/OrderDetail/${n.id}`).then(function(n){$.loaded();$.view({title:"订单详情",template:n.data,dialogWidth:700})}).catch(function(n){$.loaded();$.alert(n)})},reversePay:function(n){i(n)}},created:function(){this.loadData()}}),o={payment:`
        <div class="form-horizontal" id="paymentView">
            <div class="form-group" style="margin-bottom: 5px;">
                <label class="col-xs-3">
                    订单实际金额：
                </label>
                <div class="col-xs-4">
                    <span style='color: red;'>{{'￥ ' + amount}}</span>
                </div>
                <div class="col-xs-5">
                    <a @click.prevent="add()" class="text-primary pull-right"><i class="fa fa-plus"> 新增</i></a>
                </div>
            </div>
            <hr style="margin: 0 0 5px 0;" />
            <div class="form-group" v-for="payment in payments">
                <div class="col-xs-6">
                    <div class="input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-paypal"></i>
                        </span>
                        <select class="form-control" v-model="payment.name">
                            <option v-for="item in paymentTypes" :value="item.name">{{item.name}}</option>
                        </select>
                    </div>
                </div>
                <div class="col-xs-4">
                    <div class="input-group">
                        <span class="input-group-addon"><i class="fa fa-cny"></i></span>
                        <input type="number" class="form-control" v-model="payment.amount" @blur="calcReceiveAmount()" placeholder="支付金额" />
                    </div>
                </div>
                <div class="col-xs-2">
                    <a @click="remove(payment)" class="text-primary"><i class="fa fa-minus-circle" style="font-size: 20px;margin-top: 6px;"></i></a>
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 5px;">
                <label class="col-xs-offset-7 col-xs-4">
                    收款总金额：
                    <span style='color: red;'>{{'￥ ' + receiveAmount}}</span>
                </label>
            </div>
        </div>
        `},i=function(n){function f(n){$.loading();axios.get(`/Store/GetOrder/${n.id}`).then(function(n){$.loaded();s(n.data)}).catch(function(n){$.loaded();$.alert(n)})}function s(n){$.view({title:"反结账",template:u,load:function(){r=new Vue({el:"#reservePay",data:{entity:n},methods:{editPayment:function(){var i;$.view({title:"修改订单支付方式",footDisplay:"block",template:o.payment,load:function(){i=new Vue({el:"#paymentView",data:{amount:r.entity.actualAmount,payments:JSON.parse(JSON.stringify(r.entity.tangOrderPayments)),paymentTypes:JSON.parse(JSON.stringify(t)||null),receiveAmount:0},methods:{add:function(){if(this.payments.length>=5){$.alert("最多只能设置5种支付方式","warning");return}var t={name:"",amount:+(this.amount-this.receiveAmount).toFixed(2),tangOrderId:n.id,orderObjectId:n.objectId};this.payments.push(t);this.calcReceiveAmount()},remove:function(n){this.payments.length!==1&&(this.payments.remove(n),this.calcReceiveAmount())},calcReceiveAmount:function(){this.receiveAmount=+this.payments.sum(n=>+n.amount).toFixed(2)}},created:function(){if(this.calcReceiveAmount(),!t){var n=this;axios.get("/Store/GetPayments").then(function(i){t=i.data;n.paymentTypes=JSON.parse(JSON.stringify(t))})}}});this.css("z-index",1061);this.next().css("z-index",1060);e.call(this,i)},submit:function(){if(i.calcReceiveAmount(),i.amount!==i.receiveAmount)return $.alert("收款总金额必须等于订单实际金额"),!1;if(i.payments.first(n=>!n.name))return $.alert("请选择收款方式"),!1;if(i.payments.first(n=>n.amount<=0))return $.alert("收款金额必须大于零"),!1;var n=i.payments.group(n=>n.name);return n.first(n=>n.list.length>1)?($.alert("不能存在两种相同的支付方式"),!1):(i.payments.forEach(n=>{if(!(n.id>0)){var i=t.first(t=>t.name===n.name);n.paymentTypeId=i.id}}),$.loading(),axios.post("/Store/UpdatePayments",i.payments).then(function(){}).catch(function(n){$.loaded();$.alert(n)}),!0)}})}}});e.call(this,r)},dialogWidth:800})}var u,r,t;axios.get("/Store/ReservePay").then(function(t){u=t.data;i=f;f(n)})},r,u,f;Vue.filter("paymentFilter",function(n){if(!n||n.length===0)return"";if(n.length===1)return n[0].name;let t="";return n.forEach(function(n){t+=`${n.name}:${n.amount},`}),t=t.slice(0,t.length-1)});r={1:"收银台",2:"扫码点餐"};Vue.filter("sourceFilter",function(n){return r[n]});u={0:"未定义",1:"快餐",2:"中餐"};Vue.filter("modeFilter",function(n){return u[n]});f={1:"正在点单",2:"用餐中",4:"已结算",8:"反结算",16:"已取消",32:"已退款"};Vue.filter("statusFilter",function(n){return f[n]});$("#txtStartDate").datetimepicker(jdCat.utilData.dateOptions).on("changeDate",function(){t.startDate=this.value});$("#txtEndDate").datetimepicker(jdCat.utilData.dateOptions).on("changeDate",function(){t.endDate=this.value})})();