(function(){function i(n){this.on("hidden.bs.modal",function(){n&&n.$destroy()})}var r=jdCat.utilMethods.now(),n=new Vue({el:"#app",data:{startDate:r,endDate:r,code:undefined,paging:{pageIndex:1,pageSize:20,pageCount:1},items:null},methods:{loadData:function(){var n=this;axios.get(`/Store/GetOrders?pageIndex=${this.paging.pageIndex}&pageSize=${this.paging.pageSize}&startDate=${this.startDate}&endDate=${this.endDate}&code=${this.code||""}`).then(function(t){n.paging.pageCount=Math.ceil(t.data.count/n.paging.pageSize);n.items=t.data.rows}).catch(function(n){$.alert(n)})},next:function(){if(this.paging.pageIndex>=this.paging.pageCount){this.paging.pageIndex=this.paging.pageCount;return}this.paging.pageIndex++;this.loadData()},pre:function(){if(this.paging.pageIndex<=1){this.paging.pageIndex=1;return}this.paging.pageIndex--;this.loadData()},page:function(n){this.paging.pageIndex!==n&&(this.paging.pageIndex=n,this.loadData())},search:function(){this.loadData()},orderStatus:function(){return statusName={1:"正在点单",2:"正在用餐",4:"已结算",8:"反结算",16:"已取消",32:"已退款"},function(n){return statusName[n]}}(),catInfo:function(n){$.loading();axios.get(`/Store/OrderDetail/${n.id}`).then(function(n){$.loaded();$.view({title:"订单详情",template:n.data,dialogWidth:700})}).catch(function(n){$.loaded();$.alert(n)})},reversePay:function(n){f(n)}},created:function(){this.loadData()}}),u={payment:`          
        <div class="form-horizontal" id="paymentView">
            <div class="form-group" style="margin-bottom: 5px;">
                <label class="col-xs-3">
                    订单实际金额：
                </label>
                <div class="col-xs-4">
                    <span style='color: red;'>{{'￥ ' + amount}}</span>
                </div>
                <div class="col-xs-5">
                    <a @click.prevent="add()" class="text-primary pull-right"><i class="fa fa-plus"> 新增</i></a>
                </div>
            </div>
            <hr style="margin: 0 0 5px 0;" />
            <div class="form-group" v-for="payment in payments">
                <div class="col-xs-6">
                    <div class="input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-paypal"></i>
                        </span>
                        <select class="form-control" v-model="payment.name">
                            <option v-for="item in paymentTypes" :value="item.name">{{item.name}}</option>
                        </select>
                    </div>
                </div>
                <div class="col-xs-4">
                    <div class="input-group">
                        <span class="input-group-addon"><i class="fa fa-cny"></i></span>
                        <input type="number" class="form-control" v-model.number="payment.amount" @blur="calcReceiveAmount()" placeholder="支付金额" />
                    </div>
                </div>
                <div class="col-xs-2">
                    <a @click="remove(payment)" class="text-primary"><i class="fa fa-minus-circle" style="font-size: 20px;margin-top: 6px;"></i></a>
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 5px;">
                <label class="col-xs-offset-7 col-xs-4">
                    收款总金额：
                    <span style='color: red;'>{{'￥ ' + receiveAmount}}</span>
                </label>
            </div>
        </div>
        `,product:`
        <div class="form-horizontal" id="productView">
            <p class="text-primary">注：添加的商品金额将累加到订单的总金额中，添加完成后，请修改对应的支付方式，否则报表统计将会出错！</p>
            <div class="form-group" style="margin-bottom: 5px;">
                <div class="col-xs-12" style="relative">
                    <div class="input-group">
                        <span class="input-group-addon">
                            商品搜索
                        </span>
                        <input text="number" class="form-control" v-model="search.key" @keyup.esc="clear()" @keyup.enter="enter()" @keyup.up="up()" @keyup.down="down()" @blur="blur()" @focus="focus()" />
                        <span class="input-group-addon">
                            <i class="fa fa-search"></i>
                        </span>
                    </div>
                    <div class="search-container" style="width: 90%;" v-bind:style="{'min-height': search.boxHeight}">
                        <div class="search-box">
                            <div class="search-item" v-for="item in search.result" v-bind:class="{'selected': item.selected}" @click="clickItem(item)">
                                {{item.name}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr />
            <div class="form-group">
                <label class="col-xs-3 control-label">
                    商品名称：
                </label>
                <label class="col-xs-7 control-label" style="text-align: left;">
                    {{entity.name}}
                </label>
            </div>
            <div class="form-group" v-show="formats.length > 1">
                <label class="col-xs-3 control-label">
                    商品规格：
                </label>
                <div class="col-xs-7">
                    <select class="form-control" v-model="entity.formatId">
                        <option v-for="format in formats" :value="format.id">{{format.name}}</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-3 control-label">
                    商品单价：
                </label>
                <div class="col-xs-7">
                    <div class="input-group">
                        <span class="input-group-addon">
                            <i class="fa fa-cny"></i>
                        </span>
                        <input text="number" class="form-control" v-model.number="entity.price" />
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-3 control-label">
                    商品数量：
                </label>
                <div class="col-xs-7">
                    <input text="number" class="form-control" v-model.number="entity.quantity" />
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-3 control-label">
                    商品总价：
                </label>
                <label class="col-xs-7 control-label" style="text-align: left;">
                    <i class="fa fa-cny" style="color: red;"> {{entity.amount}}</i>
                </label>
            </div>
            
        </div>
        `},f=function(r){function h(n){$.loading();axios.get(`/Store/GetOrder/${n.id}`).then(function(n){$.loaded();c(n.data)}).catch(function(n){$.loaded();$.alert(n)})}function c(r){$.view({title:"反结账",template:s,load:function(){o=new Vue({el:"#reservePay",data:{entity:r},methods:{editPayment:function(){var n;$.view({title:"修改订单支付方式",footDisplay:"block",template:u.payment,load:function(){n=new Vue({el:"#paymentView",data:{amount:o.entity.actualAmount,payments:JSON.parse(JSON.stringify(o.entity.tangOrderPayments)),paymentTypes:JSON.parse(JSON.stringify(e)||null),receiveAmount:0},methods:{add:function(){if(this.payments.length>=5){$.alert("最多只能设置5种支付方式","warning");return}var n={name:"",amount:+(this.amount-this.receiveAmount).toFixed(2),tangOrderId:r.id,orderObjectId:r.objectId};this.payments.push(n);this.calcReceiveAmount()},remove:function(n){this.payments.length!==1&&(this.payments.remove(n),this.calcReceiveAmount())},calcReceiveAmount:function(){this.receiveAmount=+this.payments.sum(n=>n.amount).toFixed(2)}},created:function(){if(this.calcReceiveAmount(),!e){var n=this;axios.get("/Store/GetPayments").then(function(t){e=t.data;n.paymentTypes=JSON.parse(JSON.stringify(e))})}}});this.css("z-index",1061);this.next().css("z-index",1060);i.call(this,n)},submit:function(){if(n.calcReceiveAmount(),n.amount!==n.receiveAmount)return $.alert("收款总金额必须等于订单实际金额"),!1;if(n.payments.first(n=>!n.name))return $.alert("请选择收款方式"),!1;if(n.payments.first(n=>n.amount<=0))return $.alert("收款金额必须大于零"),!1;var t=n.payments.group(n=>n.name);return t.first(n=>n.list.length>1)?($.alert("不能存在两种相同的支付方式"),!1):(n.payments.forEach(n=>{if(!(n.id>0)){var t=e.first(t=>t.name===n.name);n.paymentTypeId=t.id;n.paymentTypeObjectId=t.id}}),$.loading(),axios.post(`/Store/UpdatePayments/${r.id}`,n.payments).then(function(n){$.loaded();$.alert("修改成功","success");r.tangOrderPayments=n.data}).catch(function(n){$.loaded();$.alert(n)}),!0)}})},add:function(){t(r)},ret:function(t){if(r.orderDiscount!==10){$.alert("整单折扣的订单不可以退货！","warning");return}$.primary("退货后订单金额将会减去退掉的商品金额，需要您手动修改支付方式，否则将导致报表错误，确定退货吗？",function(){return $.loading(),axios.post("/Store/RetTangProduct",t).then(function(i){$.loaded();$.alert("退货成功","success");r.actualAmount=i.data.actualAmount;r.amount=i.data.amount;r.originalAmount=i.data.originalAmount;t.productStatus=16;var u=n.items.first(n=>n.id===r.id);u&&(u.actualAmount=r.actualAmount)}).catch(function(n){$.loaded();$.alert(n)}),!0})}}});i.call(this,o)},dialogWidth:800})}var s,o,e;axios.get("/Store/ReservePay").then(function(n){s=n.data;f=h;h(r)})},t=function(r){function o(t){$.view({title:"添加订单商品",template:u.product,footDisplay:"block",load:function(){f=new Vue({el:"#productView",data:{products:[],entity:{name:"",quantity:1,price:0,amount:0,description:"",productIdSet:"",productId:0,orderId:0,formatId:0},formats:[],search:{key:"",result:[],boxHeight:0}},watch:{"search.key":function(){this.seek(this.search.key)},"entity.quantity":function(){this.calc()},"entity.price":function(){this.calc()},"entity.formatId":function(){var n=this.formats.first(n=>n.id===this.entity.formatId);this.entity.description=n.name;this.entity.price=n.price}},methods:{focus:function(){this.seek(this.search.key)},blur:function(){var n=this;setTimeout(function(){n.search.boxHeight=0},200)},seek:function(n){if(!n){this.search.boxHeight="0";this.search.result=[];return}this.search.boxHeight="120px";e.forEach(n=>n.selected=!1);this.search.result=e.filter(t=>t.name.indexOf(n)>-1||t.code.indexOf(n)>-1||t.pinyin.indexOf(n)>-1||t.firstLetter.indexOf(n)>-1).slice(0,8)},down:function(){var n=this;this.move(function(t){return t===n.search.result.length-1?t=0:t++,t})},up:function(){var n=this;this.move(function(t){return t===0?t=n.search.result.length-1:t===-1?t=0:t--,t})},enter:function(){var n=this.search.result.filter(n=>n.selected);n.length!==0&&this.clickItem(n[0])},clear:function(){this.search.key=""},move:function(n){if(this.search.result.length!==0){var r,t,i=this.search.result.filter(n=>n.selected);i.length>0&&(r=i[0]);t=this.search.result.indexOf(r);t=n(t);i.forEach(n=>n.selected=!1);this.search.result[t].selected=!0}},clickItem:function(n){$.extend(this.entity,{name:n.name,price:n.format[0].price,productIdSet:n.productIdSet,productId:n.id,orderId:t.id,formatId:n.format[0].id,orderObjectId:t.orderObjectId});this.formats=n.format;this.clear()},calc:function(){this.entity.amount=+(this.entity.price*this.entity.quantity).toFixed(2)}}});this.css("z-index",1061);this.next().css("z-index",1060);i.call(this,f)},submit:function(){return f.entity.name?f.entity.price<=0?($.alert("商品金额必须大于零"),!1):f.entity.quantity<=0?($.alert("商品数量必须大于零"),!1):($.loading(),axios.post("/Store/IncreaseOrderProduct",$.extend({},f.entity,{discount:10,originalPrice:f.entity.price})).then(function(i){$.loaded();$.alert("添加成功","success");t.actualAmount=i.data.order.actualAmount;t.amount=i.data.order.amount;t.originalAmount=i.data.order.originalAmount;t.tangOrderProducts.push(i.data.product);var r=n.items.first(n=>n.id===t.id);r&&(r.actualAmount=t.actualAmount)}).catch(function(n){$.loaded();$.alert(n)}),!0):($.alert("请选择需要添加的商品"),!1)}})}var e,f;axios.get("/Store/GetSimpleStoreProducts").then(function(n){e=n.data||[];e.forEach(n=>n.selected=!1);t=o;t(r)})},e,o,s;Vue.filter("paymentFilter",function(n){if(!n||n.length===0)return"";if(n.length===1)return n[0].name;let t="";return n.forEach(function(n){t+=`${n.name}:${n.amount},`}),t=t.slice(0,t.length-1)});e={1:"收银台",2:"扫码点餐"};Vue.filter("sourceFilter",function(n){return e[n]});o={0:"未定义",1:"快餐",2:"中餐"};Vue.filter("modeFilter",function(n){return o[n]});s={1:"正在点单",2:"用餐中",4:"已结算",8:"反结算",16:"已取消",32:"已退款"};Vue.filter("statusFilter",function(n){return s[n]});$("#txtStartDate").datetimepicker(jdCat.utilData.dateOptions).on("changeDate",function(){n.startDate=this.value});$("#txtEndDate").datetimepicker(jdCat.utilData.dateOptions).on("changeDate",function(){n.endDate=this.value})})();